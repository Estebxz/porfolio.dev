---
import { getItems } from "@constants/project";

const projects = await getItems();
const statusParam = Astro.url.searchParams.get("status");
const status = statusParam === "done" || statusParam === "in_progress" ? statusParam : "all";

const filters = [
  { key: "all", label: "Todos", href: "/#project" },
  { key: "in_progress", label: "En progreso", href: "/?status=in_progress#project" },
  { key: "done", label: "Terminado", href: "/?status=done#project" },
];
---

<div class="content-wrapper">
  <h1 class="section-title">Proyectos</h1>

  <nav class="projects-filters" aria-label="Filtrar proyectos">
    <ul class="projects-filters__list" role="list">
      {
        filters.map(({ key, label, href }) => (
          <li>
            <a
              class="projects-filters__link"
              href={href}
              aria-current={status === key ? "page" : undefined}
              data-filter={key}
            >
              {label}
            </a>
          </li>
        ))
      }
    </ul>
  </nav>

  <section aria-labelledby="projects-title">
    <ul class="projects-list" role="list">
      {
        projects.map(({ slug, title, status }) => (
          <li class="project-item">
            <a
              class="hollow-text"
              href={`/projects/${slug}`}
              aria-label={`Ver proyecto ${title}`}
              transition:name={`title-${slug}`}
              data-status={status}
            >
              {title}
            </a>
          </li>
        ))
      }
    </ul>
  </section>
</div>

<style>
  .projects-filters {
    margin-top: 1rem;
    margin-bottom: 1rem;
  }

  .projects-filters__list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    padding: 0;
    margin: 0;
  }

  .projects-filters__link {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.35rem;

    color: var(--color-alpha-100);
    background: var(--color-primary-900);
    border: 1px solid var(--color-border-btn);
    border-radius: 0.4rem;

    padding: 0.45rem 0.85rem;
    text-decoration: none;
    text-transform: uppercase;
    white-space: normal;

    font-weight: 400;
    font-size: 0.85rem;
    line-height: 1;
    transition:
      border-color 0.2s ease,
      background-color 0.2s ease,
      color 0.2s ease;
  }

  .projects-filters__link:hover {
    background: var(--color-primary-700);
    transform: translateY(-1px);
  }

  .projects-filters__link[aria-current="page"] {
    border-color: var(--color-emphasis);
    background: oklch(70.7% 0.165 254.624/10%);
    color: var(--color-emphasis);
    transform: translateY(0);
  }

  .hollow-text {
    font-family: var(--font-bartle);
    text-transform: uppercase;

    font-size: clamp(2.4rem, 7vw, 5.5rem);
    line-height: 1.05em;
    max-width: 100vw;
    width: 100%;

    color: transparent;
    cursor: pointer;

    /* Stroke */
    -webkit-text-stroke: 1.2px oklch(0.8853 0 0);

    /* Relleno animado */
    background: linear-gradient(oklch(0.8853 0 0));
    background-size: 100% 0%;
    background-position: bottom;
    background-repeat: no-repeat;
    -webkit-background-clip: text;
    background-clip: text;

    /* Multiline clamp */
    background-clip: text;
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-line-clamp: 1;
    overflow: hidden;

    /* Animación */
    transition:
      background-size 0.45s ease,
      -webkit-text-stroke-color 0.45s ease;
  }

  .hollow-text:hover {
    background-size: 100% 100%;
  }

  @media (max-width: 374px) {
    .hollow-text {
      max-width: 90vw;
      font-size: clamp(1.8rem, 9vw, 2.4rem);
      -webkit-text-stroke-width: 0.8px;
      -webkit-line-clamp: 3;
    }
  }

  /* ─── Mobile (375px - 639px) ─── */
  @media (min-width: 375px) and (max-width: 639px) {
    .hollow-text {
      max-width: 82vw;
      font-size: clamp(2rem, 8vw, 2.8rem);
      -webkit-text-stroke-width: 1px;
      -webkit-line-clamp: 3;
    }
  }

  /* ─── Tablet landscape / Desktop pequeño (768px - 1023px) ─── */
  @media (min-width: 768px) and (max-width: 1023px) {
    .hollow-text {
      font-size: clamp(3.5rem, 6vw, 4.5rem);
      letter-spacing: 0.05em;
      -webkit-text-stroke-width: 1.2px;
      -webkit-line-clamp: 1;
    }
  }

  /* ─── Desktop (1024px - 1439px) ─── */
  @media (min-width: 1024px) and (max-width: 1439px) {
    .hollow-text {
      font-size: clamp(4rem, 5.5vw, 5.5rem);
      letter-spacing: 0.05em;
      -webkit-text-stroke-width: 1.5px;
      -webkit-line-clamp: 1;
      max-width: 100%;
    }
  }

  /* ─── Desktop grande (1440px+) ─── */
  @media (min-width: 1440px) {
    .hollow-text {
      font-size: clamp(5rem, 5vw, 6.5rem);
      letter-spacing: 0.05em;
      -webkit-text-stroke-width: 1.8px;
      letter-spacing: -0.01em;
      -webkit-line-clamp: 1;
      max-width: 100%;
    }
  }
</style>

<script>
  const VALID = new Set(["all", "done", "in_progress"]);
  const STORAGE_KEY = "projects.status";

  function getStatusFromUrl() {
    const url = new URL(window.location.href);
    const s = url.searchParams.get("status");
    if (s && VALID.has(s)) return s;

    const stored = sessionStorage.getItem(STORAGE_KEY);
    return stored && VALID.has(stored) ? stored : "all";
  }

  function setUrl(nextStatus: string) {
    const status = VALID.has(nextStatus) ? nextStatus : "all";
    const url = new URL(window.location.href);

    if (status === "all") url.searchParams.delete("status");
    else url.searchParams.set("status", status);

    url.hash = "project";
    history.replaceState({}, "", url);
  }

  function applyFilter(nextStatus: string) {
    const status = VALID.has(nextStatus) ? nextStatus : "all";

    if (status === "all") sessionStorage.removeItem(STORAGE_KEY);
    else sessionStorage.setItem(STORAGE_KEY, status);

    document
      .querySelectorAll<HTMLAnchorElement>("a[data-filter]")
      .forEach((a) => {
        if (a.getAttribute("data-filter") === status)
          a.setAttribute("aria-current", "page");
        else a.removeAttribute("aria-current");
      });

    document
      .querySelectorAll<HTMLAnchorElement>("a[data-status]")
      .forEach((a) => {
        const itemStatus = a.getAttribute("data-status");
        const li = a.closest("li");
        if (!li) return;
        li.hidden = status === "all" ? false : itemStatus !== status;
      });
  }

  applyFilter(getStatusFromUrl());

  document
    .querySelectorAll<HTMLAnchorElement>("a[data-filter]")
    .forEach((a) => {
      a.addEventListener("click", (e) => {
        const key = a.getAttribute("data-filter") ?? "all";
        if (!VALID.has(key)) return;
        e.preventDefault();
        setUrl(key);
        applyFilter(key);
        document.getElementById("project")?.scrollIntoView();
      });
    });

  window.addEventListener("popstate", () => {
    applyFilter(getStatusFromUrl());
  });
</script>
